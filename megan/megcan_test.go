package megan
 
import (
	"testing"
	"os"
)

func GetWithinCanopyMeteorologyTestData() WithinCanopyMeteorology {
	SunleafTK := [][]float64{
		{295.6182, 295.8877, 295.1347, 295.1322, 295.3771}, 
		{297.5717, 297.822, 298.8787, 299.3174, 299.4514},   
		{294.3002, 294.5834, 290.011, 289.1228, 289.5473}, 
		{292.5432, 292.8132, 288.2105, 287.3336, 287.7623}, 
		{290.731, 290.9884, 286.3135, 285.4398, 285.8767}, 
		{289.8369, 290.0916, 285.3109, 284.4263, 284.8631}, 
		{290.4691, 290.733, 285.7823, 284.8609, 285.3195},  
		{291.3685, 291.6474, 286.4804, 285.512, 285.9868},  
		{294.6352, 294.9289, 289.4309, 288.3809, 288.8667}, 
		{298.6524, 298.9738, 293.1259, 291.9767, 292.4758},
		{298.1715, 298.5284, 292.9918, 291.8577, 292.336},  
		{295.7728, 296.1424, 291.1261, 290.1046, 290.5679}, 
		{295.0275, 295.345, 290.2632, 289.2638, 289.7237},  
		{297.2255, 297.455, 298.7089, 299.2364, 299.3915},  
		{294.641, 294.9759, 290.9461, 290.0213, 290.3602}, 
		{295.333, 295.665, 291.4472, 290.5173, 290.8682}, 
		{298.3278, 298.7188, 294.6497, 293.7282, 294.0971}, 
		{300.7791, 301.1797, 297.1644, 296.2126, 296.5812}, 
		{299.8176, 300.1154, 295.8929, 294.9973, 295.349},  
		{299.3605, 299.6334, 295.8917, 295.0285, 295.33},  
		{298.7494, 298.9307, 294.842, 293.9898, 294.2694},  
		{298.438, 298.5883, 294.546, 293.6351, 293.8756}, 
		{299.3921, 299.5471, 295.5123, 294.5977, 294.8355}, 
		{300.4998, 300.666, 296.5661, 295.6325, 295.8716}, 
		{300.1864, 300.3885, 296.3932, 295.5674, 295.8512}}
	ShadeleafTK := [][]float64{
		{295.1602, 295.4964, 292.3763, 291.6741, 291.9568}, 
		{295.8602, 296.2285, 293.0199, 292.0325, 292.1878}, 
		{294.3002, 294.5834, 290.011, 289.1228, 289.5473},  
		{292.5432, 292.8132, 288.2105, 287.3336, 287.7623}, 
		{290.731, 290.9884, 286.3135, 285.4398, 285.8767},  
		{289.8369, 290.0916, 285.3109, 284.4263, 284.8631}, 
		{290.4691, 290.733, 285.7823, 284.8609, 285.3195}, 
		{291.3685, 291.6474, 286.4804, 285.512, 285.9868},  
		{294.6352, 294.9289, 289.4309, 288.3809, 288.8667},
		{298.6524, 298.9738, 293.1259, 291.9767, 292.4758}, 
		{298.1715, 298.5284, 292.9918, 291.8577, 292.336},  
		{295.7728, 296.1424, 291.1261, 290.1046, 290.5679},
		{295.0275, 295.345, 290.2632, 289.2638, 289.7237}, 
		{295.1813, 295.5639, 291.663, 290.4395, 290.6359}, 
		{294.6278, 294.9633, 290.8946, 289.9553, 290.2935}, 
		{295.3333, 295.6653, 291.4485, 290.519, 290.8698},  
		{298.3281, 298.7191, 294.6508, 293.7297, 294.0986}, 
		{300.7793, 301.1798, 297.1649, 296.2132, 296.5818},
		{299.8179, 300.1157, 295.8944, 294.9991, 295.3509},
		{299.3608, 299.6337, 295.893, 295.0302, 295.3317}, 
		{298.7496, 298.9308, 294.8429, 293.991, 294.2707}, 
		{298.4382, 298.5885, 294.5468, 293.636, 293.8766},  
		{299.3922, 299.5472, 295.5131, 294.5988, 294.8366}, 
		{300.5, 300.6662, 296.5672, 295.6338, 295.8729},  
		{300.1868, 300.3888, 296.3948, 295.5695, 295.8533}}
	SunPPFD := [][]float64{
		{617.0796, 581.216, 534.6226, 496.9291, 476.1383}, 
		{1229, 1218.555, 1169.987, 1133.71, 1117.465}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{1432.69, 1418.28, 1360.212, 1327.029, 1314.218}, 
		{241.908, 196.2697, 144.8788, 107.2672, 87.51214}, 
		{166.2688, 134.9006, 99.57848, 73.72714, 60.14907}, 
		{221.3287, 179.5729, 132.5539, 98.14188, 80.06743}, 
		{298.6783, 242.3297, 178.8786, 132.4403, 108.0493}, 
		{168.7707, 136.9305, 101.0769, 74.83653, 61.05415}, 
		{274.2107, 222.4782, 164.225, 121.5909, 99.19792}, 
		{91.48035, 74.22169, 54.78764, 40.56435, 33.09375}, 
		{62.28123, 50.53127, 37.30027, 27.61683, 22.53074}, 
		{61.27688, 49.7164, 36.69876, 27.17148, 22.1674}, 
		{60.90872, 49.41769, 36.47827, 27.00823, 22.03422}, 
		{91.83125, 74.50639, 54.99779, 40.71994, 33.22069}}
	ShadePPFD := [][]float64{
		{235.1983, 199.3347, 152.7413, 115.0479, 94.25706}, 
		{159.3897, 148.9443, 100.3765, 64.09938, 47.8544}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{0, 0, 0, 0, 0}, 
		{156.2114, 141.8008, 83.73295, 50.55008, 37.73889}, 
		{241.908, 196.2697, 144.8788, 107.2672, 87.51214}, 
		{166.2688, 134.9006, 99.57848, 73.72714, 60.14907}, 
		{221.3287, 179.5729, 132.5539, 98.14188, 80.06743}, 
		{298.6783, 242.3297, 178.8786, 132.4403, 108.0493}, 
		{168.7707, 136.9305, 101.0769, 74.83653, 61.05415}, 
		{274.2107, 222.4782, 164.225, 121.5909, 99.19792}, 
		{91.48035, 74.22169, 54.78764, 40.56435, 33.09375}, 
		{62.28123, 50.53127, 37.30027, 27.61683, 22.53074}, 
		{61.27688, 49.7164, 36.69876, 27.17148, 22.1674}, 
		{60.90872, 49.41769, 36.47827, 27.00823, 22.03422}, 
		{91.83125, 74.50639, 54.99779, 40.71994, 33.22069}}
	SunFrac := [][]float64{
		{0.9111186, 0.6343481, 0.3760942, 0.22486, 0.1589793}, 
		{0.8086445, 0.3566621, 0.1114906, 0.03613561, 0.01703344}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.2, 0.2, 0.2, 0.2, 0.2}, 
		{0.7528764, 0.2536033, 0.05476007, 0.01251686, 0.004684461}, 
		{0.9009956, 0.6008364, 0.3350512, 0.1887849, 0.1283043}, 
		{0.9366858, 0.7258638, 0.5015498, 0.3480518, 0.2718508}, 
		{0.95176, 0.7847132, 0.5927957, 0.4489425, 0.3718549}, 
		{0.9592984, 0.8155808, 0.644033, 0.5094811, 0.434578}, 
		{0.9630322, 0.8312343, 0.6709146, 0.5423182, 0.4693694}, 
		{0.9642918, 0.8365706, 0.6802174, 0.5538514, 0.4817112}, 
		{0.9634591, 0.8330401, 0.6740549, 0.5462016, 0.4735181}, 
		{0.9602855, 0.8196954, 0.65104, 0.51797, 0.443522}, 
		{0.9536892, 0.7925196, 0.6055322, 0.4637364, 0.3870063}, 
		{0.9406589, 0.7410105, 0.5242341, 0.372282, 0.2953098}, 
		{0.9113433, 0.6351085, 0.3770557, 0.2257312, 0.1597351}}
	
	return WithinCanopyMeteorology{SunleafTK, ShadeleafTK, SunPPFD, ShadePPFD, SunFrac}
}

func TestMegcan(t *testing.T) {
	go_output, err := run_go_megcan()
	if err != nil {
		t.Errorf("ERROR:", err)
	}
	
	expected_output := GetWithinCanopyMeteorologyTestData()

	if !are_megcan_outputs_equal(go_output, expected_output) {
		t.Errorf("Go and standalone versions produce different results (epsilon=%v)\n", EPSILON)
	}
}

func TestMegcanAgainstStandalone(t *testing.T) {
	if os.Getenv("MEGAN_STANDALONE_TEST") == "" {
		t.Skip("skipping test; $MEGAN_STANDALONE_TEST not set")
	}

	go_output, err := run_go_megcan()
	if err != nil {
		t.Errorf("ERROR:", err)
	}
	
	standalone_output := run_standalone_megcan()
	
	if !are_megcan_outputs_equal(go_output, standalone_output) {
		t.Errorf("Go and standalone versions produce different results (epsilon=%v)\n", EPSILON)
	}
}

func run_go_megcan() (output WithinCanopyMeteorology, err error) {
	start_date := 2013145
	start_time := 0
	time_increment := 10000
	latitude := 24.9699
	longitude := -106.4971
	leaf_area_index := []float64{1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165, 1.5165}
	temperature := []float64{297.082306, 297.727692, 296.182587, 294.303192, 292.372711, 291.441986, 292.145111, 293.152191, 296.554413, 300.812408, 300.780090, 298.426788, 297.198090, 297.152710, 296.918396, 297.635986, 301.010590, 303.602386, 301.852600, 301.242310, 300.171814, 299.743988, 300.724091, 301.895599, 301.726196}	
	incoming_photosynthetic_active_radiation := []float64{170.3816, 169.4689, 169.6857, 170.1833, 170.7162, 171.3177, 169.3093, 168.2702, 165.8572, 164.0267, 117.4694, 131.7137, 154.3903, 151.1533, 79.20123, 51.97546, 69.20062, 93.79958, 52.06078, 85.48535, 27.98305, 19.00437, 18.71786, 18.64834, 28.50706}	
	wind_speed := []float64{5.094378, 4.802262, 4.926229, 5.486905, 6.240457, 6.69226, 6.650759, 6.507776, 6.637711, 6.326972, 4.112444, 3.278793, 4.672177, 5.296508, 5.2028, 4.718732, 4.439407, 5.261704, 7.043137, 8.519012, 9.130258, 9.083385, 8.90703, 8.649946, 7.982096}
	pressure := []float64{82208.09, 82074.07, 79915.18, 77888.27, 75807.18, 74659.62, 74743.4, 74867.3, 77366.51, 80634.96, 80539.65, 78878.96, 77915.15, 77785.88, 77854.4, 79161.82, 82624.84, 84891.8, 84355.8, 84116.77, 84441.45, 84297.27, 85458.9, 86283.28, 85663.48}
	water_vapor_mixing_ratio := []float64{0.007762248, 0.007521978, 0.007424137, 0.007346272, 0.007168575, 0.00690266, 0.006551034, 0.006116394, 0.005739891, 0.00535665, 0.005357311, 0.005891337, 0.006285786, 0.006444469, 0.006613181, 0.006978375, 0.007246723, 0.00755674, 0.008359249, 0.008913932, 0.009405961, 0.009717779, 0.009829475, 0.009771289, 0.009766233}
	canopy_type_factor := []float64{0, 21.6363, 30.5448, 34.4223, 33.8522, 36.0447}
	
	return ConvertAboveCanopyMeteorologyToWithinCanopyMeteorology(start_date, start_time, time_increment, latitude, longitude, leaf_area_index, temperature, incoming_photosynthetic_active_radiation, wind_speed, pressure, water_vapor_mixing_ratio, canopy_type_factor)
}

func run_standalone_megcan() WithinCanopyMeteorology {
	// Run standalone MEGCAN script
	run_command("cd ./MEGAN3/work/; ./run.megcan.v3.single.csh")
	
	// Extract outputs from NETCDF files
	output_file := "./MEGAN3/Output/INT/CANMET.tceq_12km.2013145.single.nc"
	SunleafTK := parse_netcdf_file("SunleafTK", output_file)
	ShadeleafTK := parse_netcdf_file("ShadeleafTK", output_file)
	SunPPFD := parse_netcdf_file("SunPPFD", output_file)
	ShadePPFD := parse_netcdf_file("ShadePPFD", output_file)
	SunFrac := parse_netcdf_file("SunFrac", output_file)
	
	timestep_count := 25
	canopy_layers := 5
	return WithinCanopyMeteorology{Convert1Dto2D(SunleafTK, timestep_count, canopy_layers), 
						 Convert1Dto2D(ShadeleafTK, timestep_count, canopy_layers), 
						 Convert1Dto2D(SunPPFD, timestep_count, canopy_layers), 
						 Convert1Dto2D(ShadePPFD, timestep_count, canopy_layers), 
						 Convert1Dto2D(SunFrac, timestep_count, canopy_layers)}
}

func are_megcan_outputs_equal(output1 WithinCanopyMeteorology, output2 WithinCanopyMeteorology) bool {
	SunleafTK_equal := arrays_approximately_equal_2d(output1.SunleafTK, output2.SunleafTK, EPSILON, "SunleafTK")
	ShadeleafTK_equal := arrays_approximately_equal_2d(output1.ShadeleafTK, output2.ShadeleafTK, EPSILON, "ShadeleafTK")
	SunPPFD_equal := arrays_approximately_equal_2d(output1.SunPPFD, output2.SunPPFD, EPSILON, "SunPPFD")
	ShadePPFD_equal := arrays_approximately_equal_2d(output1.ShadePPFD, output2.ShadePPFD, EPSILON, "ShadePPFD")
	SunFrac_equal := arrays_approximately_equal_2d(output1.SunFrac, output2.SunFrac, EPSILON, "SunFrac")
	
	return SunleafTK_equal && ShadeleafTK_equal && SunPPFD_equal && ShadePPFD_equal && SunFrac_equal
}